---
title: "03_modeling"
# output: html_document
---
```{r}
library(magrittr)
library(tableone)
library(kableExtra)
library(summarytools)
library(broom)
library(vroom)
library(stringr)
library(stringi)
library(mgcv)
library(parglm)
library(tibble)
library(tidyverse)
library(boot)
library(caTools)
library(caret)
library(pROC)
library(fastDummies)
library(forcats)
library(ggplot2)

```

# Load Data

```{r}
final_df_er_sepsis <- read.csv("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Figures/selected_data.csv")
message("Datos cargados correctamente")
```

```{r}
final_df_er_sepsis <- final_df_order %>%
  select(patientunitstayid, sex,age,ethnicity,er_los_hrs,unitdischargestatus,apachescoreIV,bact_resist_level, final_charlson_score, hist_metastasis_bin,hist_vih_sida_bin,hist_cirrosis_liver_bin, hist_stroke_bin,hist_renal_bin,hist_diabetes_bin,hist_cancer_bin,hist_leukemia_bin,hist_lymphoma_bin,hist_myocardial_infar_bin,hist_chf_bin,hist_pvd_bin,hist_tia_bin,hist_dementia_bin,hist_copd_bin,hist_ctd_bin,hist_pud_bin,hist_liver_bin,unit_cardiac_icu,unit_ccu_cticu,unit_csicu,unit_cticu,unit_med_surg_icu,unit_micu,unit_neuro_icu,unit_sicu,apacheadmissiondx_other, apacheadmissiondx_pneumonia_aspiration, apacheadmissiondx_pneumonia_bacterial, apacheadmissiondx_pneumonia_other, apacheadmissiondx_sepsi_Cutaneous, apacheadmissiondx_sepsis_gi, apacheadmissiondx_sepsis_pulmonary, apacheadmissiondx_sepsis_renal_uti, apacheadmissiondx_sepsis_unknown)
# Create a sample data frame (replace this with your actual data)
set.seed(42)
# Check the variance of each variable
variance_info <- apply(final_df_er_sepsis, 2, var)
print("Variance of each variable:")
print(variance_info)
# Identify variables with less than 0.16 variance
low_variance_vars <- nearZeroVar(final_df_er_sepsis, saveMetrics = TRUE)
# Display information about variables with low variance
print(low_variance_vars)

# Remove variables with less than 0.16 variance
data_cleaned <- final_df_er_sepsis[, -low_variance_vars$nzv]

# Display the cleaned data frame
print("Data frame after removing low variance variables:")
print(data_cleaned)
```



#Creating functions

```{r}
# Metric performance
precision <- function(matrix){
  #True positive
  tp <- matrix[2,2]
  #False positive
  fp <- matrix[1,2]
  return(tp/(tp + fp))
}
recall <- function(matrix){
  #True positive
  tp <- matrix[2,2]
  #False positive
  fn <- matrix[2,1]
  return(tp/(tp+fn))
}

extract_coef_pval_OR <- function(model) {
  as.data.frame(tibble(
    term = names(model$coefficients),
    estimate = model$coefficients,
    std.error = sqrt(diag(vcov(model))),
    statistic = model$coefficients / sqrt(diag(vcov(model))),
    p.value = 2 * (1 - pnorm(abs(statistic))),
    OR = round(exp(estimate), 2),
    OR_lower = round(exp(estimate - 1.96 * std.error), 2),
    OR_upper = round(exp(estimate + 1.96 * std.error), 2)
  ))
}

set.seed(123)

#Create a fucntion to split the data with balanced outcome percentages
balanced_split <- function(data,outcome_var, split_ratio) {
  unique_outcomes <- unique(data[[outcome_var]])
  train_data <- data.frame()
  test_data <- data.frame()

#Iterate over each unique outcome and split the data
for (outcome in unique_outcomes) {
  subset_data <- data[data[[outcome_var]] == outcome, ]
  split <- sample(nrow(subset_data), size = round(nrow(subset_data) * split_ratio))
  train_subset <- subset_data[split, ]
  test_subset <- subset_data[-split, ]
  train_data <- rbind(train_data,train_subset)
  test_data <- rbind(test_data, test_subset)
}
 return(list(train_data = train_data,test_data = test_data))
}
#Define the evaluation metric
f1_score <- function(data,lev = NULL, model = NULL) {
  predictions <- factor(ifelse(data$obs == lev[1], lev[1], lev[2]), levels = lev)
  reference <- factor(data$obs,levels = lev)
  f1 <- F_meas(predictions, reference,beta = 1)$F
  return(f1)
}

```

#General Additive Modeling (GAM): The GAM approach provides a robust framework to explore the complex relationships between multiple predictors and a binary health outcome, facilitating a comprehensive analysis in the field of public health research

```{r}
set.seed(123)

#Divida los datos en conjuntos de entrenamiento y prueba con porcentajes de resultados equilibrados 
split_ratio <- 0.9
split_data <- balanced_split(final_df_er_sepsis, "unitdischargestatus", split_ratio)
train_data <- split_data$train_data
test_data <- split_data$test_data
place.knots(x = train_data$er_los_hrs, nk = 4)
```



# Odds Ratio and forest plot
The model's coefficients, odds ratios, and corresponding confidence intervals were then extracted to generate a forest plot, offering a concise visual representation of the estimated odds ratios and their precision intervals for each predictor variable. The GAM approach provides a robust framework to explore the complex relationships between multiple predictors and a binary health outcome, facilitating a comprehensive analysis in the field of public health research.
```{r}
gam_mortality_unit <- 
  gam(
    unitdischargestatus ~ s(er_los_hrs, k = 3) + sex + age + ethnicity + unitdischargestatus + apachescoreIV + bact_resist_level + final_charlson_score + hist_renal_bin + hist_diabetes_bin + hist_cancer_bin + hist_chf_bin + hist_copd_bin + hist_other_bin + unittype + apacheadmissiondx, data = final_df_er_sepsis,
    family = binomial) 

coef_data <- data.frame(coef = coef(gam_mortality_unit))
se <- sqrt(diag(vcov(gam_mortality_unit)))
z_value <- qnorm(0.976) # 95% confidence level - detection prevalence
#Redondea decimales a 2

coef_data <- round(coef_data, 2)
# Calculate the odds ratios and their respective lower and upper confidence limits
coef_data$OR <- exp(coef_data$coef)
coef_data$OR_lower <- exp(coef_data$coef - qnorm(0.975) * se)  # Usar 0.975 para obtener IC del 95%
coef_data$OR_upper <- exp(coef_data$coef + qnorm(0.975) * se)

library(ggplot2)

# Filtrar las variables de interés
#coef_data2 <- coef_data %>%
#  filter(predictor != "(Intercept)")

# Calcular la categoría (Adverse, Protective, Inconclusive)
coef_data <- coef_data %>%
  mutate(
    adverse_protective = case_when(
      OR_lower > 1 & OR_upper > 1 ~ "Adverse",
      OR_lower < 1 & OR_upper < 1 ~ "Protective",
      TRUE ~ "Inconclusive"
    )
  )
coef_data$adverse_protective <- as.factor(coef_data$adverse_protective)

# Crear el forest plot
forest_plot <- ggplot(coef_data, aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = rownames(coef_data))) +
  geom_point(aes(color = adverse_protective), size = 2) +
  geom_errorbarh(aes(color = adverse_protective), height = 0.1, linewidth = 0.5) +
  geom_vline(xintercept = 1, linetype = "solid", color = "gray50") +
  labs(
    x = "Odds Ratio (with 95% Confidence Interval)",
    y = "Predictor Variable",
    title = "Odds Ratios and Confidence Intervals for mortality emergency sepsis ICU"
  ) +
  scale_color_manual(values = c("Adverse" = "#c0392b", "Protective" = "#27ae60", "Inconclusive" = "gray70"))
  theme_minimal() 
#    theme(
#    plot.background = element_rect(fill = "white"),
#    panel.grid.major.y = element_blank(),
#    panel.grid.minor.y = element_blank(),
#    plot.title = element_text(hjust = 0.5),
#    axis.ticks = element_blank(),
#    axis.text.x = element_text(color = "#2c3e50"),
#    axis.text.y = element_text(color = "#2c3e50", hjust = 0), # Ajuste la posición horizontal del texto en el eje y
#    # axis.title.y = element_text(margin = margin(t = 0, r = 20, b= 0, l = 0)), # Ajuste los márgenes del título del ej))
#    axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))  # Ajuste los márgenes del título del eje x
#  )

print(forest_plot)

```





# GAM PLOT

```{r}
# Variable er_los_hrs
gam_plot_mortality_unit <- plot(gam_mortality_unit, pages = 1)
x <- gam_plot_mortality_unit[[1]]$x
fit <- gam_plot_mortality_unit[[1]]$fit
se <- gam_plot_mortality_unit[[1]]$se

fit_values <- as.vector(fit)
se_values <- as.vector(se)

fit_chance <- (exp(fit) / (1 + exp(fit))) 
lower_bound_chance <- (exp(fit - 2 * se) / (1 + exp(fit - 2 * se)))
upper_bound_chance <- (exp(fit + 2 * se) / (1 + exp(fit + 2 * se))) 

df_er_los_hrs_mortality <- 
  data.frame(
    x = x, fit_chance = fit_chance,
    lower_bound_chance = lower_bound_chance,upper_bound_chance = upper_bound_chance
  )

```

```{r}

ggplot(df_er_los_hrs_mortality, aes(x = x, y = fit_chance)) +
  geom_ribbon(aes(ymin = lower_bound_chance, ymax = upper_bound_chance), alpha = 0.3) +
  geom_line(color = "blue") +  # Añade la línea de ajuste
  labs(
    x = "Emergency Room Length of Stay (hours)", 
    y = "Mortality in the ICU probability (%)", 
    title = "Generative Additive Modeling"
  ) +
  theme_minimal() +
  theme(
    strip.text = element_text(face = "italic"),
    panel.border = element_rect(color = "black", fill = NA, size = 0.6),
    legend.position = "none"
  )

```








