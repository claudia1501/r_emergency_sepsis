---
title: "03_modeling"
# output: html_document
---
```{r}
library(magrittr)
library(tableone)
library(kableExtra)
library(summarytools)
library(broom)
library(vroom)
library(stringr)
library(stringi)
library(tidyr)
library(mgcv)
library(parglm)
library(tibble)
library(tidyverse)
library(boot)
library(caTools)
library(caret)
library(pROC)
library(fastDummies)
library(forcats)
library(ggplot2)

```

# Load Data

```{r}
final_df_er_sepsis <- read.csv("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Figures/selected_data.csv")
message("Datos cargados correctamente")
```
#Creating functions
```{r}
# Metric performance
precision <- function(matrix){
  #True positive
  tp <- matrix[2,2]
  #False positive
  fp <- matrix[1,2]
  return(tp/(tp + fp))
}
recall <- function(matrix){
  #True positive
  tp <- matrix[2,2]
  #False positive
  fn <- matrix[2,1]
  return(tp/(tp+fn))
}

extract_coef_pval_OR <- function(model) {
  as.data.frame(tibble(
    term = names(model$coefficients),
    estimate = model$coefficients,
    std.error = sqrt(diag(vcov(model))),
    statistic = model$coefficients / sqrt(diag(vcov(model))),
    p.value = 2 * (1 - pnorm(abs(statistic))),
    OR = round(exp(estimate), 2),
    OR_lower = round(exp(estimate - 1.96 * std.error), 2),
    OR_upper = round(exp(estimate + 1.96 * std.error), 2)
  ))
}

set.seed(123)

#Create a fucntion to split the data with balanced outcome percentages
balanced_split <- function(data,outcome_var, split_ratio) {
  unique_outcomes <- unique(data[[outcome_var]])
  train_data <- data.frame()
  test_data <- data.frame()

#Iterate over each unique outcome and split the data
for (outcome in unique_outcomes) {
  subset_data <- data[data[[outcome_var]] == outcome, ]
  split <- sample(nrow(subset_data), size = round(nrow(subset_data) * split_ratio))
  train_subset <- subset_data[split, ]
  test_subset <- subset_data[-split, ]
  train_data <- rbind(train_data,train_subset)
  test_data <- rbind(test_data, test_subset)
}
 return(list(train_data = train_data,test_data = test_data))
}
#Define the evaluation metric
f1_score <- function(data,lev = NULL, model = NULL) {
  predictions <- factor(ifelse(data$obs == lev[1], lev[1], lev[2]), levels = lev)
  reference <- factor(data$obs,levels = lev)
  f1 <- F_meas(predictions, reference,beta = 1)$F
  return(f1)
}

```


#General Additive Modeling (GAM): The GAM approach provides a robust framework to explore the complex relationships between multiple predictors and a binary health outcome, facilitating a comprehensive analysis in the field of public health research.
```{r}
set.seed(123)

#Divida los datos en conjuntos de entrenamiento y prueba con porcentajes de resultados equilibrados 
split_ratio <- 0.9
split_data <- balanced_split(final_df_er_sepsis, "unitdischargestatus", split_ratio)
train_data <- split_data$train_data
test_data <- split_data$test_data
place.knots(x = train_data$er_los_hrs, nk = 4)


```

```{r}
lr_mortality_unit <- 
  glm(
    unitdischargestatus ~ er_los_hrs + sex + age + ethnicity + sepsis_bin + apachescoreIV + bact_resist_level + final_charlson_score + hist_metastasis_bin +  hist_cirrosis_liver_bin + hist_stroke_bin + hist_renal_bin + hist_diabetes_bin + hist_cancer_bin + hist_leukemia_bin + hist_lymphoma_bin + hist_myocardial_infar_bin + hist_chf_bin + hist_pvd_bin + hist_tia_bin + hist_dementia_bin + hist_copd_bin + hist_ctd_bin + hist_pud_bin + hist_liver_bin + unittype_CCU.CTICU + unittype_CSICU + unittype_CTICU + unittype_Med.Surg.ICU + unittype_MICU + unittype_Neuro.ICU + unittype_SICU + apacheadmissiondx_sepsis_cutaneous + apacheadmissiondx_sepsis_gi + apacheadmissiondx_sepsis_pulmonary + apacheadmissiondx_sepsis_renal_uti + apacheadmissiondx_sepsis_unknown 
,data = final_df_er_sepsis,
    family = binomial()
  )
```

```{r}
summary(lr_mortality_unit)
```


```{r}
coef_df <- as.data.frame(summary(lr_mortality_unit)$coefficients)
coef_df$OddsRatio<- exp(coef_df[,"Estimate"])
coef_df$LowerCI <- exp(coef_df[, "Estimate"] - 1.96 * coef_df[, "Std. Error"])
coef_df$UpperCI<- exp(coef_df[, "Estimate"] + 1.96 * coef_df[, "Std. Error"])
```

```{r}
# Define the plot
ggplot(coef_df, aes(x = Estimate, y = reorder(row.names(coef_df), Estimate))) +
  geom_point() +
  geom_errorbarh(aes(xmin = LowerCI, xmax = UpperCI)) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  xlab("Estimate") +
  ylab("Variable") 
```


##Train the GAM model

```{r}
gam_mortality_unit <- 
  gam(
    unitdischargestatus ~ s(er_los_hrs, k = 3) + sex + age + ethnicity + sepsis_bin + apachescoreIV + bact_resist_level + final_charlson_score + hist_metastasis_bin +  hist_cirrosis_liver_bin + hist_stroke_bin + hist_renal_bin + hist_diabetes_bin + hist_cancer_bin + hist_leukemia_bin + hist_lymphoma_bin + hist_myocardial_infar_bin + hist_chf_bin + hist_pvd_bin + hist_tia_bin + hist_dementia_bin + hist_copd_bin + hist_ctd_bin + hist_pud_bin + hist_liver_bin + unittype_CCU.CTICU + unittype_CSICU + unittype_CTICU + unittype_Med.Surg.ICU + unittype_MICU + unittype_Neuro.ICU + unittype_SICU + apacheadmissiondx_sepsis_cutaneous + apacheadmissiondx_sepsis_gi + apacheadmissiondx_sepsis_pulmonary + apacheadmissiondx_sepsis_renal_uti + apacheadmissiondx_sepsis_unknown 
,data = final_df_er_sepsis%>%filter(er_los_hrs<=24),
    family = binomial()
  )
```

```{r}
library(ggplot2)
library(mgcv)
library(boot)

# Función para obtener los coeficientes del modelo GAM
gam_mortality_unit <- 
  gam(
    unitdischargestatus ~ s(er_los_hrs, k = 3) + sex + age + ethnicity + sepsis_bin + apachescoreIV + bact_resist_level + final_charlson_score + hist_metastasis_bin +  hist_cirrosis_liver_bin + hist_stroke_bin + hist_renal_bin + hist_diabetes_bin + hist_cancer_bin + hist_leukemia_bin + hist_lymphoma_bin + hist_myocardial_infar_bin + hist_chf_bin + hist_pvd_bin + hist_tia_bin + hist_dementia_bin + hist_copd_bin + hist_ctd_bin + hist_pud_bin + hist_liver_bin + unittype_CCU.CTICU + unittype_CSICU + unittype_CTICU + unittype_Med.Surg.ICU + unittype_MICU + unittype_Neuro.ICU + unittype_SICU + apacheadmissiondx_sepsis_cutaneous + apacheadmissiondx_sepsis_gi + apacheadmissiondx_sepsis_pulmonary + apacheadmissiondx_sepsis_renal_uti + apacheadmissiondx_sepsis_unknown 
,data = final_df_er_sepsis %>% filter(er_los_hrs<=24),
    family = binomial
  )

# Realizar bootstrapping
# Load libraries
library(ggplot2)
library(ggdist)

# Create a data frame with coefficients, standard errors, and variables
coef_data <- data.frame(
  Variable = rownames(coef(gam_mortality_unit)),
  Estimate = coef(gam_mortality_unit),
  Std.Error = summary(gam_mortality_unit)$coefficients[, "Std. Error"]
)

# Calculate the confidence intervals
coef_data$OR <- exp(coef_data$Estimate)
coef_data$CI_lower <- exp(coef_data$Estimate - 1.96 * coef_data$Std.Error)
coef_data$CI_upper <- exp(coef_data$Estimate + 1.96 * coef_data$Std.Error)

# Create a forest plot
ggplot(coef_data, aes(x = Estimate, y = Variable)) +
  geom_pointh(aes(xmin = Lower, xmax = Upper), position = position_dodgev(height = 0.3)) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_minimal() +
  labs(title = "Forest Plot of Logistic Regression Coefficients",
       subtitle = "95% Confidence Intervals") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.y = element_blank(),
        axis.text.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
        panel.grid.minor.x = element_blank())


```



```{r}


# Make predictions on the test data
test_data$predicted <- predict(gam_mortality_unit, newdata = test_data, type = "response")
test_data$predicted_bin <- ifelse(test_data$predicted > 0.5, 1, 0)

# Calculate precision, recall, and F1 score
precision <- sum(test_data$predicted_bin == 1 & test_data$unitdischargestatus == "Sí") / sum(test_data$predicted_bin == 1)
recall <- sum(test_data$predicted_bin == 1 & test_data$unitdischargestatus == "Sí") / sum(test_data$unitdischargestatus == "Sí")
f1 <- 2 * precision * recall / (precision + recall)

# Print the results
print(precision)
print(recall)
print(f1)

# Convertir las variables a factores con los mismos niveles
test_data$predicted_bin <- as.factor(test_data$predicted_bin)
test_data$unitdischargestatus <- as.factor(test_data$unitdischargestatus)

# Calcular la matriz de confusión
confusion_matrix <- confusionMatrix(test_data$predicted_bin, test_data$unitdischargestatus)
print(confusion_matrix)

```
# Odds Ratio and forest plot
The model's coefficients, odds ratios, and corresponding confidence intervals were then extracted to generate a forest plot, offering a concise visual representation of the estimated odds ratios and their precision intervals for each predictor variable. The GAM approach provides a robust framework to explore the complex relationships between multiple predictors and a binary health outcome, facilitating a comprehensive analysis in the field of public health research.
```{r}
gam_mortality_unit <- 
  gam(
    unitdischargestatus ~ s(er_los_hrs, k = 3) + sex + age + ethnicity + sepsis_bin + apachescoreIV + bact_resist_level + final_charlson_score + hist_metastasis_bin +  hist_cirrosis_liver_bin + hist_stroke_bin + hist_renal_bin + hist_diabetes_bin + hist_cancer_bin + hist_leukemia_bin + hist_lymphoma_bin + hist_myocardial_infar_bin + hist_chf_bin + hist_pvd_bin + hist_tia_bin + hist_dementia_bin + hist_copd_bin + hist_ctd_bin + hist_pud_bin + hist_liver_bin + unittype_CCU.CTICU + unittype_CSICU + unittype_CTICU + unittype_Med.Surg.ICU + unittype_MICU + unittype_Neuro.ICU + unittype_SICU + apacheadmissiondx_sepsis_cutaneous + apacheadmissiondx_sepsis_gi + apacheadmissiondx_sepsis_pulmonary + apacheadmissiondx_sepsis_renal_uti + apacheadmissiondx_sepsis_unknown 
,data = final_df_er_sepsis %>% filter(er_los_hrs<=24),
    family = binomial
  )
# Extract the model coefficients and their confidence intervals
coef_data <- data.frame(coef = coef(gam_mortality_unit))
se <- sqrt(diag(vcov(gam_mortality_unit)))
z_value <- qnorm(0.976) # 95% confidence level - detection prevalence
#Redondea decimales a 2
coef_data <- round(coef_data, 2)

# Calculate the odds ratios and their respective lower and upper confidence limits
coef_data$OR <- exp(coef_data$coef)
coef_data$OR_lower <- exp(coef_data$coef + z_value * se)
coef_data$OR_upper <- exp(coef_data$coef - z_value * se)

# Calculate the p-values
p_values <- 2 * (1 - pnorm(abs(coef_data$coef) / se))
coef_data$p_value <- p_values

#Create a variable to store the predictor names
coef_data$predictor <- rownames(coef_data)

variable_order <- rev(c(
"Intercept", "Sex (female)", "Age (>16- 90)", "Ethnicity: Asian", "Ethnicity: Caucasian", "Ethnicity: Hispanic", "Ethnicity: American", "Ethnicity: Other", "ID hospital", "Time in emergency before ICU", "Sepsis", "Infection", "apache score IV", "bact not resistant", "bact resistant", "Charlson score", "History metastasis", "History cirrosis", "History stroke", "History renal", "History diabetes", "History cancer", "History leukemia", "History lymphoma", "History myocardial infar", "History chf", "History pvd", "History tia", "History dementia", "History copd", "History ctd", "History pud", "History liver", "Unit Type CCU CTICU", "Unit type CSICU", "Unit type CTICU", "Unit type Med.surg.ICU", "Unit type MICU", "Unit type Neuro ICU", "Unit type SICU", "Apache admission: sepsis,GI", "Apache admission:sepsis,cutaneous/soft tissue", "Apache admission:sepsis,pulmonary", "Apache admission:sepsis,renal/UTI", "Apache admission: sepsis unknown", "Apache admission:other", "er_los_hrs = 0.4068635", "er_los_hrs = 2.448543"
 ))

coef_data2 <- coef_data %>%
  
   mutate(
     #Esto sale de las variables que forman el coef_data
   predictor = case_when(
      predictor == "(Intercept)" ~ "Intercept",
      predictor == "sex" ~ "Sex (female)",
      predictor == "age" ~ "Age (>16- 90)",
      predictor == "ethnicityAsian" ~ "Ethnicity: Asian",
      predictor == "ethnicityCaucasian" ~ "Ethnicity: Caucasian",
      predictor == "ethnicityHispanic" ~ "Ethnicity: Hispanic",
      predictor == "ethnicityNative American" ~ "Ethnicity: American",
      predictor == "ethnicityother/unknown" ~ "Ethnicity: Other",
      predictor == "hospitalid" ~ "ID hospital",
      predictor == "er_los_hrs" ~ "Time in emergency before ICU",
      predictor == "sepsis_bin" ~"Sepsis",
      predictor == "apachescoreIV" ~ "apache score IV",
      predictor == "bact_resist_levelNot resistant" ~ "bact not resistant",
      predictor == "bact_resist_levelResistant" ~ "bact resistant",
      predictor == "final_charlson_score" ~ "Charlson score",
      predictor == "hist_metastasis_bin" ~ "History metastasis",
      predictor == "hist_cirrosis_liver_bin" ~ "History cirrosis",
      predictor == "hist_stroke_bin" ~ "History stroke",
      predictor == "hist_renal_bin" ~ "History renal",
      predictor == "hist_diabetes_bin" ~ "History diabetes",
      predictor == "hist_cancer_bin" ~ "History cancer",
      predictor == "hist_leukemia_bin" ~ "History leukemia",
      predictor == "hist_lymphoma_bin" ~ "History lymphoma",
      predictor == "hist_myocardial_infar_bin" ~ "History myocardial infar",
      predictor == "hist_chf_bin" ~ "History chf",
      predictor == "hist_pvd_bin" ~ "History pvd",
      predictor == "hist_tia_bin" ~ "History tia",
      predictor == "hist_dementia_bin" ~ "History dementia",
      predictor == "hist_copd_bin" ~ "History copd",
      predictor == "hist_ctd_bin" ~ "History ctd",
      predictor == "hist_pud_bin" ~ "History pud",
      predictor == "hist_liver_bin" ~ "History liver",
      predictor == "unittype_CCU.CTICU" ~ "Unit Type CCU CTICU",
      predictor == "unittype_CSICU" ~ "Unit type CSICU",
      predictor == "unittype_CTICU" ~ "Unit type CTICU",
      predictor == "unittype_Med.Surg.ICU" ~ "Unit type Med.surg.ICU",
      predictor == "unittype_MICU" ~ "Unit type MICU",
      predictor == "unittype_Neuro.ICU" ~ "Unit type Neuro ICU",
      predictor == "unittype_SICU" ~ "Unit type SICU",
      predictor == "apacheadmissiondx_sepsis_gi" ~ "Apache admission: sepsis,GI",
      predictor == "apacheadmissiondx_sepsis_cutaneous" ~ "Apache admission:sepsis,cutaneous/soft tissue",
      predictor == "apacheadmissiondx_sepsis_pulmonary" ~ "Apache admission:sepsis,pulmonary",
      predictor == "apacheadmissiondx_sepsis_renal_uti" ~ "Apache admission:sepsis,renal/UTI",
      predictor == "apacheadmissiondx_sepsis_unknown" ~ "Apache admission: sepsis unknown",
      predictor == "apacheadmissiondx_other" ~ "Apache admission:other",
      predictor == "s(er_los_hrs).1" ~ "er_los_hrs = 0.4068635", #la primera parte del rango de er_los_hrs, un aumento de una unidad en er_los_hrs está asociado con un aumento de 0.4068635 en el log-odds de unitdischargestatus, manteniendo constantes todas las demás variables.
      predictor == "s(er_los_hrs).2" ~ "er_los_hrs = 2.448543", #la segunda parte del rango de er_los_hrs, un aumento de una unidad en er_los_hrs está asociado con un aumento de 2.448543 en el log-odds de unitdischargestatus, manteniendo constantes todas las demás variables.
    ),
    
    predictor = factor(predictor, levels = variable_order),
    adverse_protective = case_when(
      OR_lower > 1 & OR_upper > 1 ~ "Adverse",
      OR_lower < 1 & OR_upper < 1 ~ "Protective",
      TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))
  ) %>% 
 
  arrange(predictor)
coef_data2$OR <- round(coef_data2$OR, 2)
coef_data2$OR_lower <- round(coef_data2$OR_lower, 2)
coef_data2$OR_upper <- round(coef_data2$OR_upper, 2)
coef_data2$p_value <- round(coef_data2$p_value, 2)
#Set up the forest plot using ggplot2 
forest_plot <-
  ggplot(
    coef_data2,
aes(x = OR, xmin = OR_lower,xmax = OR_upper, y = predictor)
  ) + 
  xlim(0,5) +
  geom_point(size = 2,aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.1,aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "solid", color = "gray50") +
  labs(
    x = "Odds Ratio (with 95% Confidence Interval)",
    y = "Predictor Variable",
    title = "Odds Ratios and Confidence Intervals for mortality emergency sepsis ICU"
  ) +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b","#27ae60","gray70"),
    #breaks = c("#c0392b", "#27ae60", "gray90"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome"
  ) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50", hjust = 0), # Ajuste la posición horizontal del texto en el eje y
    # axis.title.y = element_text(margin = margin(t = 0, r = 20, b= 0, l = 0)), # Ajuste los márgenes del título del ej))
    axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))  # Ajuste los márgenes del título del eje x
  )
print(forest_plot)


```


# GAM PLOT
```{r}
# Variable er_los_hrs
gam_plot_mortality_unit <- plot(gam_mortality_unit, pages = 1)
x <- gam_plot_mortality_unit[[1]]$x
fit <- gam_plot_mortality_unit[[1]]$fit
se <- gam_plot_mortality_unit[[1]]$se

fit_chance <- (exp(fit) / (1 + exp(fit))) * 10
lower_bound_chance <- (exp(fit - 2 * se) / (1 + exp(fit - 2 * se))) * 10
upper_bound_chance <- (exp(fit + 2 * se) / (1 + exp(fit + 2 * se))) * 10

df_er_los_hrs_mortality <- 
  data.frame(
    x = x, fit_chance = fit_chance,
    lower_bound_chance = lower_bound_chance,upper_bound_chance = upper_bound_chance
  )


```

```{r}

ggplot(df_er_los_hrs_mortality, aes(x = x, y = fit_chance)) +
  geom_ribbon(aes(ymin = lower_bound_chance, ymax = upper_bound_chance), alpha = 0.3) +
  geom_line(color = "blue") +  # Añade la línea de ajuste
  labs(
    x = "Emergency Room Length of Stay (hours)", 
    y = "Mortality in the ICU probability (%)", 
    title = "Generative Additive Modeling"
  ) +
  theme_minimal() +
  theme(
    strip.text = element_text(face = "italic"),
    panel.border = element_rect(color = "black", fill = NA, size = 0.6),
    legend.position = "none"
  )

```


