---
title: "01_dataset_creation"
author: "Claudia Jiménez"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
 output:
   html_notebook:
    code_folding: hide
    number_sections: yes
    theme: flatly
    toc: yes
    toc_float: yes
---
# Environment

```{r message=FALSE, warning=FALSE}
library(bigrquery)
library(DBI)
library(dplyr)
library(summarytools)
library(tidyverse)
library(forcats)
library(tidyr)

```

# BigQuery related functions

This chunks creates the run_query and getSQL function.

```{r}
# Function that takes in a SQL command and runs it on BigQuery. This avoids the connection data in each iteration
run_query<-function(query){
  query_output<-dbGetQuery(con,query)
  return(query_output)
}

# Function for reading SQL files from a folder
getSQL <- function(filepath) {
  con = file(filepath, "r")
  sql.string <- ""
  while (TRUE) {
    line <- readLines(con, n = 1)
    if (length(line) == 0) {
      break
    }
    line <- gsub("\\t", " ", line)
    if (grepl("--", line) == TRUE) {
      line <- paste(sub("--", "/*", line), "*/")
    }
    sql.string <- paste(sql.string, line)
  }
  close(con)
  return(sql.string)
}
```

## Setting up connection

```{r}
bigrquery::bq_auth() # UNCOMMENT WHEN HAVEN TOCKEN ISSUES!!!
# Establecer la conexión a BigQuery
project_id <- "extended-altar-382009"

con <- dbConnect(
  bigrquery::bigquery(),
  project = project_id
)

```
# Data Extraction

Loading queries and extracting the data.
```{r}
patients_dates <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/patients_date.sql"))
patients_apacheadmission <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/patient_apacheadmission.sql"))
patients_emergency <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/patient_emergency.sql"))
patients_admit <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/patients_admit.sql"))
patients_total <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/patient_total.sql"))
apachescore <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/apachescore.sql"))
sensitivitylevel <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/sensitivitylevel.sql"))
apache_sepsis <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/apache_sepsis.sql"))
apache_infection <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/apache_infection.sql"))
charlson_score <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/charlson_score.sql"))
history_dx <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/history_dx.sql"))

```

# Joining 1º df
```{r}
#Unimos df
dfs_to_join <- list(patients_total,patients_admit,patients_apacheadmission,patients_emergency, apachescore,sensitivitylevel,charlson_score,history_dx) #apache_sepsis,apache_infection
final_df <- Reduce(function(x,y) merge(x,y, by = "patientunitstayid", all.x = TRUE), dfs_to_join)
```

## Imputations 

### Age
```{r}

##Eliminamos una fila que se ha colado con edad 4 años
final_df$age <- as.numeric(gsub("> 89", "90", final_df$age))
final_df <- final_df[final_df$age >= 16,]
final_df <- final_df %>%
  drop_na(age)
```

### Sex

```{r}
#Variable género = sex, a numérica: hombre = 0, mujer = 1
final_df <- final_df %>%
 rename(sex = gender) %>%
  mutate(sex = ifelse(
    sex == "Male", "0",
    ifelse(
      sex == "Female", "1",
      NA_character_  # Agregué un valor por defecto para el caso en que sex no sea ni "Male" ni "Female"
    )
  )) %>%
  mutate(sex = as.factor(sex)) %>%
  mutate(sex = forcats::fct_na_value_to_level(sex)) %>%
  filter(sex != "Unknown")
```

### Ethnicity

```{r}
# Change empty string = other
final_df <- final_df %>%
  mutate(ethnicity = ifelse(ethnicity == "", "other", ethnicity)) %>%
   mutate(ethnicity = ifelse(ethnicity %in% c("other", "Other/Unknown"), "other/unknown", ethnicity))

final_df$ethnicity <- as.factor(final_df$ethnicity)
```

### Hospitaladmitoffset

```{r}
# Cambio de nombre, paso de minutos a horas y valores absolutos
final_df <- final_df %>%
  mutate(er_los_hrs = abs(hospitaladmitoffset/60)) %>%
  select(-hospitaladmitoffset)

# Quitar valores muy altos considerados outcome
final_df <- final_df %>%
  filter(er_los_hrs <= 24)
```

### Stratify: Unitdischargestatus (estado del que sale de la unidad)

```{r}
final_df <- final_df %>%
  mutate(
    unitdischargestatus = ifelse(
      unitdischargestatus == 'Expired', '1',
      ifelse(trimws(unitdischargestatus) == '' | unitdischargestatus == 'Alive', '0', NA_character_)
    )
  )

final_df$unitdischargestatus <- as.factor(final_df$unitdischargestatus)
```

### Unitstaytype

```{r}
# Eliminamos NA
final_df <- final_df %>%
  drop_na(unitstaytype)
```


### Variables sepsis and infection (bin)

```{r}
#Variable sepsis_bin and infection_bin. Change: no = 0; sí = 1
#final_df <- final_df %>%
#  mutate(sepsis_bin = recode(sepsis_bin, "no" = "0")) %>%
#  mutate(sepsis_bin = recode(sepsis_bin, "sí" = "1")) %>%
#  mutate(infection_bin = recode(infection_bin, "no" = "0")) %>%
#  mutate(infection_bin = recode(infection_bin, "sí" = "1"))
```

### Apache admission dx

```{r}
#Eliminamos filas sin valores, NA
final_df <- final_df %>% 
  drop_na(apacheadmissiondx)

# Variable apache admission, agrupar en las 5 categorías con mayor valor y el resto agrupadas en la variable other (esto se hace debido a la poca cantidad que hay de muchas de esas categorias de diagnósticos)

# Cuenta la frecuencia de cada categoría
#apache_counts <- final_df %>%
#  count(apacheadmissiondx, name = "Frequency")
# Identifica las 5 categorías más frecuentes
#top_categories <- apache_counts %>%
#  top_n(n = 15, wt = Frequency) %>%
#  pull(apacheadmissiondx)
# Agrupa las categorías menos frecuentes bajo "Other"
#final_df <- final_df %>%
#  mutate(apacheadmissiondx = fct_lump(apacheadmissiondx, n = 15, other_level = "Other"))
# Vuelve a contar la frecuencia después de la agrupación
#new_apache_counts <- final_df %>%
#  count(apacheadmissiondx, name = "Frequency")
# Muestra el resultado
#print(new_apache_counts)

#final_df <- final_df %>%
#  mutate(
#    apacheadmissiondx = recode(
#      apacheadmissiondx,
#      "Renal infection/abscess" = "other",
#      "Cellulitis and localized soft tissue infections" = "other",
#      "Sepsis, other" = "other",
#      "Sepsis, gynecologic" = "other",
#      "Infection/abscess, other surgery for" = "other",
#      "Abscess/infection-cranial, surgery for" = "other",
#      "Cellulitis and localized soft tissue infections, surgery for" = "other"
#    )
#  )
```

### Hospital admit source (emergency department)

```{r}
#Emilinamos NA
final_df <- final_df %>%
  drop_na(hospitaladmitsource)
```

### Apachescore,change name and na = median

```{r}
final_df <- final_df %>%
  mutate(apachescoreIV = ifelse(is.na(apachescoreIV) | apachescoreIV == -1, median(apachescoreIV[apachescoreIV != -1], na.rm = TRUE), apachescoreIV))
```

### Variable sensitivity:level, change na = no infection

```{r}
final_df <- final_df %>%
  mutate(
    bact_resist_level = replace_na(final_df$bact_resist_level, 'Not infection')
  )
```

### History.dx. NA = 0

```{r}
final_df<- final_df %>%
  mutate(hist_metastasis_bin = replace_na(hist_metastasis_bin, 0)) %>%
  mutate(hist_vih_sida_bin = replace_na(hist_vih_sida_bin, 0)) %>%
  mutate(hist_cirrosis_liver_bin = replace_na(hist_cirrosis_liver_bin, 0)) %>%
  mutate(hist_stroke_bin = replace_na(hist_stroke_bin, 0)) %>%
  mutate(hist_renal_bin = replace_na(hist_renal_bin, 0)) %>%
  mutate(hist_diabetes_bin = replace_na(hist_diabetes_bin, 0)) %>%
  mutate(hist_cancer_bin = replace_na(hist_cancer_bin, 0)) %>%
  mutate(hist_leukemia_bin = replace_na(hist_leukemia_bin, 0)) %>%
  mutate(hist_lymphoma_bin = replace_na(hist_lymphoma_bin, 0)) %>%
  mutate(hist_myocardial_infar_bin = replace_na(hist_myocardial_infar_bin, 0)) %>%
  mutate(hist_chf_bin = replace_na(hist_chf_bin, 0)) %>%
  mutate(hist_pvd_bin = replace_na(hist_pvd_bin, 0)) %>%
  mutate(hist_tia_bin = replace_na(hist_tia_bin, 0)) %>%
  mutate(hist_dementia_bin = replace_na(hist_dementia_bin, 0)) %>%
  mutate(hist_copd_bin = replace_na(hist_copd_bin, 0)) %>%
  mutate(hist_ctd_bin = replace_na(hist_ctd_bin, 0)) %>%
  mutate(hist_pud_bin = replace_na(hist_pud_bin, 0)) %>%
  mutate(hist_liver_bin = replace_na(hist_liver_bin, 0))
```


```{r}
#Orden de las variables
final_df_order <- final_df %>%
  select(patientunitstayid, sex,age,ethnicity,er_los_hrs,apacheadmissiondx,unittype, apachescoreIV,bact_resist_level, final_charlson_score, hist_metastasis_bin,hist_vih_sida_bin,hist_cirrosis_liver_bin, hist_stroke_bin,hist_renal_bin,hist_diabetes_bin,hist_cancer_bin,hist_leukemia_bin,hist_lymphoma_bin,hist_myocardial_infar_bin,hist_chf_bin,hist_pvd_bin,hist_tia_bin,hist_dementia_bin,hist_copd_bin,hist_ctd_bin,hist_pud_bin,hist_liver_bin,unitdischargestatus) #sepsis_bin,infection_bin
```

##Variables dummy

### Unittype

```{r}
#Transformar a dummy
unittype_ <- factor(final_df_order$unittype)
dummies_unittype <- dummy_cols(final_df_order$unittype, remove_first_dummy =  FALSE)

# Incluir en df 
final_df_order <- data.frame(final_df_order,dummies_unittype[,2:9])

#Cambiamos nombrs de las variables
final_df_order <- rename(final_df_order, unit_cardiac_icu = .data_Cardiac.ICU) %>%
  rename(unit_ccu_cticu = .data_CCU.CTICU) %>%
  rename(unit_csicu = .data_CSICU) %>%
  rename(unit_cticu = .data_CTICU) %>%
  rename(unit_med_surg_icu = .data_Med.Surg.ICU) %>%
  rename(unit_micu = .data_MICU) %>%
  rename(unit_neuro_icu = .data_Neuro.ICU) %>%
  rename(unit_sicu = .data_SICU)

```

### Apache admission dx
```{r}
#Transformar a dummy
dummies_apacheadmissiondx <- dummy_cols(final_df_order$apacheadmissiondx, remove_first_dummy = FALSE)

## Incluir dummies en el df final
final_df_order <- data.frame(final_df_order,dummies_apacheadmissiondx[,2:40])

## Cambiamos nombres de la variables dummies de apache para mejor entendimiento
final_df_order <- rename(final_df_order,apacheadmissiondx_abscess_neurologic = .data_Abscess..neurologic) %>%
  rename(apacheadmissiondx_abscess_cranial_surgery = .data_Abscess.infection.cranial..surgery.for) %>%
  rename(apacheadmissiondx_ards_non_cardiogenic_pulmonary = .data_ARDS.adult.respiratory.distress.syndrome..non.cardiogenic.pulmonary.edema)%>%
  rename(apacheadmissiondx_arthritis_septic = .data_Arthritis..septic) %>%
  rename(apacheadmissiondx_cellulitis_and_localized_infections = .data_Cellulitis.and.localized.soft.tissue.infections) %>%
  rename(apacheadmissiondx_cellulitis_and_localized_infections_surgeryfor = .data_Cellulitis.and.localized.soft.tissue.infections..surgery.for) %>%
  rename(apacheadmissiondx_cholecystectomy_cholanfitis = .data_Cholecystectomy.cholangitis..surgery.for..gallbladder.removal.) %>%
  rename(apacheadmissiondx_complications_previas_gi_surgery = .data_Complications.of.previous.GI.surgery..surgery.for..anastomotic.leak..bleeding..abscess..infection..dehiscence..etc..) %>%
  rename(apacheadmissiondx_complications_previous_open_heart_general = .data_Complications.of.previous.open.heart.surgery..i.e..bleeding..infection.etc..) %>%
  rename(apacheadmissiondx_complications_previous_open_heart_specific = .data_Complications.of.previous.open.heart.surgery..surgery.for..i.e..bleeding..infection..mediastinal.rewiring.leaking.aortic.graft.etc..) %>%
  rename(apacheadmissiondx_diverticular_disease_surgeryfor = .data_Diverticular.disease..surgery.for) %>%
  rename(apacheadmissiondx_endocarditis = .data_Endocarditis) %>%
  rename(apacheadmissiondx_fistula_surgery = .data_Fistula.abscess..surgery.for..not.inflammatory.bowel.disease.) %>%
  rename(apacheadmissiondx_gi_abscess_cyst = .data_GI.abscess.cyst) %>%
  rename(apacheadmissiondx_gi_abscess_cyst_primary = .data_GI.Abscess.cyst.primary..surgery.for) %>%
  rename(apacheadmissiondx_gi_obstuction = .data_GI.obstruction..surgery.for..including.lysis.of.adhesions.) %>%
  rename(apacheadmissiondx_gi_perforation_rupture = .data_GI.perforation.rupture) %>%
  rename(apacheadmissiondx_gi_perforation_rupture_surgery = .data_GI.perforation.rupture..surgery.for) %>%
  rename(apacheadmissiondx_infection_other_surgery = .data_Infection.abscess..other.surgery.for) %>%
  rename(apacheadmissiondx_inflammatory_bowel_disease_surgery = .data_Inflammatory.bowel.disease..surgery.for) %>%
  rename(apacheadmissiondx_meningitis = .data_Meningitis) %>%
  rename(apacheadmissiondx_pancreatitis_surgery = .data_Pancreatitis..surgery.for) %>%
  rename(apacheadmissiondx_peritonitis = .data_Peritonitis) %>%
  rename(apacheadmissiondx_peritonitis_surgery = .data_Peritonitis..surgery.for) %>%
  rename(apacheadmissiondx_pneumonia_aspiration = .data_Pneumonia..aspiration) %>%
  rename(apacheadmissiondx_pneumonia_bacterial = .data_Pneumonia..bacterial) %>%
  rename(apacheadmissiondx_pneumonia_fungal = .data_Pneumonia..fungal) %>%
  rename(apacheadmissiondx_pneumonia_other = .data_Pneumonia..other) %>%
  rename(apacheadmissiondx_pneumonia_parasitic = .data_Pneumonia..parasitic..i.e...Pneumocystic.pneumonia.) %>%
  rename(apacheadmissiondx_pneumonia_viral = .data_Pneumonia..viral) %>%
  rename(apacheadmissiondx_renal_infection = .data_Renal.infection.abscess) %>%
  rename(apacheadmissiondx_sepsi_Cutaneous = .data_Sepsis..cutaneous.soft.tissue) %>%
  rename(apacheadmissiondx_sepsis_gi = .data_Sepsis..GI) %>%
  rename(apacheadmissiondx_sepsis_gynecologic = .data_Sepsis..gynecologic) %>%
  rename(apacheadmissiondx_sepsis_other = .data_Sepsis..other) %>%
  rename(apacheadmissiondx_sepsis_pulmonary = .data_Sepsis..pulmonary) %>%
  rename(apacheadmissiondx_sepsis_renal_uti = .data_Sepsis..renal.UTI..including.bladder.) %>%
  rename(apacheadmissiondx_sepsis_unknown = .data_Sepsis..unknown) %>%
  rename(apacheadmisiondx_thoracotomy_for_thoracic_infection = .data_Thoracotomy.for.thoracic.respiratory.infection)
  
```

# Save final df

```{r}
final_df_er_sepsis <- final_df_order %>%
  select(patientunitstayid, sex,age,ethnicity,er_los_hrs,unitdischargestatus,apachescoreIV,bact_resist_level, final_charlson_score, hist_metastasis_bin,hist_vih_sida_bin,hist_cirrosis_liver_bin, hist_stroke_bin,hist_renal_bin,hist_diabetes_bin,hist_cancer_bin,hist_leukemia_bin,hist_lymphoma_bin,hist_myocardial_infar_bin,hist_chf_bin,hist_pvd_bin,hist_tia_bin,hist_dementia_bin,hist_copd_bin,hist_ctd_bin,hist_pud_bin,hist_liver_bin,unit_cardiac_icu,unit_ccu_cticu,unit_csicu,unit_cticu,unit_med_surg_icu,unit_micu,unit_neuro_icu,unit_sicu,apacheadmissiondx_abscess_neurologic,apacheadmissiondx_abscess_cranial_surgery,apacheadmissiondx_ards_non_cardiogenic_pulmonary,apacheadmissiondx_arthritis_septic,apacheadmissiondx_cellulitis_and_localized_infections,apacheadmissiondx_cellulitis_and_localized_infections_surgeryfor,apacheadmissiondx_cholecystectomy_cholanfitis,apacheadmissiondx_complications_previas_gi_surgery,apacheadmissiondx_complications_previous_open_heart_general,apacheadmissiondx_complications_previous_open_heart_specific,apacheadmissiondx_diverticular_disease_surgeryfor,apacheadmissiondx_endocarditis,apacheadmissiondx_fistula_surgery,apacheadmissiondx_gi_abscess_cyst,apacheadmissiondx_gi_abscess_cyst_primary,apacheadmissiondx_gi_obstuction,apacheadmissiondx_gi_perforation_rupture,apacheadmissiondx_gi_perforation_rupture_surgery,apacheadmissiondx_infection_other_surgery,
apacheadmissiondx_inflammatory_bowel_disease_surgery,apacheadmissiondx_meningitis,apacheadmissiondx_pancreatitis_surgery,apacheadmissiondx_peritonitis,apacheadmissiondx_peritonitis_surgery,apacheadmissiondx_pneumonia_aspiration,apacheadmissiondx_pneumonia_bacterial,apacheadmissiondx_pneumonia_fungal,apacheadmissiondx_pneumonia_other,apacheadmissiondx_pneumonia_parasitic,apacheadmissiondx_pneumonia_viral,apacheadmissiondx_renal_infection,apacheadmissiondx_sepsi_Cutaneous,apacheadmissiondx_sepsis_gi,apacheadmissiondx_sepsis_gynecologic,apacheadmissiondx_sepsis_other,apacheadmissiondx_sepsis_pulmonary,apacheadmissiondx_sepsis_renal_uti,apacheadmissiondx_sepsis_unknown,apacheadmisiondx_thoracotomy_for_thoracic_infection
) #sepsis_bin,infection_bin
```

# Variable factor

```{r}
## Variable bact_resist_level
final_df_er_sepsis$bact_resist_level <- as.factor(final_df_er_sepsis$bact_resist_level)

## Variable ethnicity
final_df_er_sepsis$ethnicity <- as.factor(final_df_er_sepsis$ethnicity)

## Variable sepsis_bin
#final_df_er_sepsis$sepsis_bin <- as.factor(final_df_er_sepsis$sepsis_bin)

## Variable infection_bin
#final_df_er_sepsis$infection_bin <- as.factor(final_df_er_sepsis$infection_bin)

##Variable sex
final_df_er_sepsis$sex <- as.factor(final_df_er_sepsis$sex)

##Variable unitdischargestatus
final_df_er_sepsis$unitdischargestatus <- as.factor(final_df_er_sepsis$unitdischargestatus)

##Variable dummies_apacheadmissiondx
final_df_er_sepsis <- final_df_er_sepsis %>%
  mutate_at(vars(apacheadmissiondx_abscess_neurologic,apacheadmissiondx_abscess_cranial_surgery,apacheadmissiondx_ards_non_cardiogenic_pulmonary,apacheadmissiondx_arthritis_septic,apacheadmissiondx_cellulitis_and_localized_infections,apacheadmissiondx_cellulitis_and_localized_infections_surgeryfor,apacheadmissiondx_cholecystectomy_cholanfitis,apacheadmissiondx_complications_previas_gi_surgery,apacheadmissiondx_complications_previous_open_heart_general,apacheadmissiondx_complications_previous_open_heart_specific,apacheadmissiondx_diverticular_disease_surgeryfor,apacheadmissiondx_endocarditis,apacheadmissiondx_fistula_surgery,apacheadmissiondx_gi_abscess_cyst,apacheadmissiondx_gi_abscess_cyst_primary,apacheadmissiondx_gi_obstuction,apacheadmissiondx_gi_perforation_rupture,apacheadmissiondx_gi_perforation_rupture_surgery,apacheadmissiondx_infection_other_surgery,
apacheadmissiondx_inflammatory_bowel_disease_surgery,apacheadmissiondx_meningitis,apacheadmissiondx_pancreatitis_surgery,apacheadmissiondx_peritonitis,apacheadmissiondx_peritonitis_surgery,apacheadmissiondx_pneumonia_aspiration,apacheadmissiondx_preumonia_bacterial,apacheadmissiondx_pneumonia_fungal,apacheadmissiondx_pnenumonia_other,apacheadmissiondx_penumonia_parasitic,apacheadmissiondx_penumonia_viral,apacheadmissiondx_renal_infection,apacheadmissiondx_sepsi_Cutaneous,apacheadmissiondx_sepsis_gi,apacheadmissiondx_sepsis_gynecologic,apacheadmissiondx_sepsis_other,apacheadmissiondx_sepsis_pulmonary,apacheadmissiondx_sepsis_renal_uti,apacheadmissiondx_sepsis_unknown,apacheadmisiondx_thoracotomy_for_thoracic_infection),as.factor)

##Variable dummies_unittype
final_df_er_sepsis <- final_df_er_sepsis %>%
  mutate_at(vars(unit_cardiac_icu,unit_ccu_cticu,unit_csicu,unit_cticu,unit_med_surg_icu,unit_micu,unit_neuro_icu,unit_sicu), as.factor)

## Variables history
final_df_er_sepsis <- final_df_er_sepsis %>%
  mutate_at(vars(hist_metastasis_bin,hist_vih_sida_bin,hist_cirrosis_liver_bin,hist_stroke_bin,hist_renal_bin,hist_diabetes_bin,hist_cancer_bin,hist_leukemia_bin,hist_lymphoma_bin,hist_myocardial_infar_bin,hist_chf_bin,hist_pvd_bin,hist_tia_bin,hist_dementia_bin,hist_copd_bin,hist_ctd_bin,hist_pud_bin,hist_liver_bin), as.factor)
```

```{r}
write.csv(final_df_er_sepsis, file = "C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Figures/selected_data.csv", row.names = FALSE)
```

# Flowchart

```{r}
dfs_to_join <- list(patients_total,patients_admit,patients_apacheadmission,patients_emergency, apachescore,sensitivitylevel,apache_sepsis,apache_infection,charlson_score,history_dx)
final_df <- Reduce(function(x,y) merge(x,y, by = "patientunitstayid", all.x = TRUE), dfs_to_join)
# we want to include septic patients that are not bleeding.

print('Initial number of patients:')
a <- nrow(final_df)
a

print('Patients >=16 ')
final_df %<>% filter(age_numeric < 16)
b <- nrow(final_df)
a - b

print('Patients with emergency department')
final_df %<>% filter(!is.na(hospitaladmitsource))
c <- nrow(final_df)
b - c

print('Patients admit')
final_df %<>% filter(is.na(unitstaytype))
d <- nrow(final_df)
c - d

print('Patients with sepsis/infection diagnossis')
final_df %<>% filter(is.na(apacheadmissiondx.x))
e <- nrow(final_df)
d-e
#####################################################################################################
# we are extracting top n apache groups
topn <- 5
top_apachedxgroup <- tail(names(sort(table(lactate_df$apachedxgroup_mod))), topn) 

lactate_df <- lactate_df %>% mutate(apache_strat = if_else(apachedxgroup_mod %in% top_apachedxgroup, apachedxgroup_mod,'Not Top5'))
#####################################################################################################

print('Patients not in Top5 Apache groups that are excluded:')
lactate_df %<>% filter(apache_strat != "Not Top5")
f <- nrow(lactate_df)
e-f

print('Patients without one lab drawn each day for the first 3 days of admission:')
lactate_df %<>% filter(atleast_one_lab_drawn_each_day_first_3days == 1 )
g <- nrow(lactate_df)
f-g

print('Final number of patients:')
nrow(lactate_df)



library(Gmisc, quietly = TRUE)
library(glue)
library(grid)
library(magrittr)

# Initial number of patients
initial_patients <- boxGrob(width = .175,
                            glue("Initial number of patients",
                                 "N = {a}",
                                 a = txtInt(a),
                                 .sep = "\n"))
# Excluded box
excluded <- boxGrob(glue("Total Excluded (N = {tot}):",
                         " - Patients <18 years old: {below_18}",
                         " - Patients without Hgb data: {no_hgb}",
                         " - Patients with stays shorter than 3 hours: {short_stays}",
                         " - Patients without a diagnose available: {no_diagnose}",
                         " - Patients not within the top5 Apache groups: {not_top5}",
                         " - Patients without one lab drawn each day for the first 3 days of admission: {no_lab_drawn}",
                         tot = txtInt(a - nrow(lactate_df)),
                         below_18 = txtInt(a - b),
                         no_hgb = txtInt(b-c),
                         short_stays = txtInt(c-d),
                         no_diagnose = txtInt(d-e),
                         not_top5 = txtInt(e - f),
                         no_lab_drawn = txtInt(f - g),
                         .sep = "\n"),
                    just = "left")


# Final number of patients
final_patients <- boxGrob(width = .175,
                            glue("Final number of patients",
                               "N = {n}",
                               n = txtInt(nrow(lactate_df)),
                               .sep = "\n"))


# Create connections
grid.newpage()
vert <- spreadVertical(initial_patients,
                       excluded,  # Include the excluded box here
                       final_patients)

for (i in 1:(length(vert) - 1)) {
  connectGrob(vert[[i]], vert[[i + 1]], type = "vert") %>%
    print
}

# Print boxes
vert
```



