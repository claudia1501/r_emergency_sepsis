---
title: "01_dataset_creation"
author: "Claudia Jiménez"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
 output:
   html_notebook:
    code_folding: hide
    number_sections: yes
    theme: flatly
    toc: yes
    toc_float: yes
---
# Environment

```{r message=FALSE, warning=FALSE}
library(bigrquery)
library(DBI)
library(dplyr)
library(summarytools)
library(tidyverse)
library(forcats)
library(tidyr)
library(DiagrammeR)
```

# BigQuery related functions

This chunks creates the run_query and getSQL function.

```{r}
# Function that takes in a SQL command and runs it on BigQuery. This avoids the connection data in each iteration
run_query<-function(query){
  query_output<-dbGetQuery(con,query)
  return(query_output)
}

# Function for reading SQL files from a folder
getSQL <- function(filepath) {
  con = file(filepath, "r")
  sql.string <- ""
  while (TRUE) {
    line <- readLines(con, n = 1)
    if (length(line) == 0) {
      break
    }
    line <- gsub("\\t", " ", line)
    if (grepl("--", line) == TRUE) {
      line <- paste(sub("--", "/*", line), "*/")
    }
    sql.string <- paste(sql.string, line)
  }
  close(con)
  return(sql.string)
}
```

## Setting up connection

```{r}
bigrquery::bq_auth() # UNCOMMENT WHEN HAVEN TOCKEN ISSUES!!!
# Establecer la conexión a BigQuery
project_id <- "extended-altar-382009"

con <- dbConnect(
  bigrquery::bigquery(),
  project = project_id
)

```

# Data Extraction

Loading queries and extracting the data.
```{r}
patients_dates <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/patients_date.sql"))
apacheadmission <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/apacheadmissiondx.sql"))
patients_emergency <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/patient_emergency.sql"))
patients_admit <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/patients_admit.sql"))
patients_total <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/patient_total.sql"))
apachescore <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/apachescore.sql"))
sensitivitylevel <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/sensitivitylevel.sql"))
apache_sepsis <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/apache_sepsis.sql"))
apache_infection <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/apache_infection.sql"))
charlson_score <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/charlson_score.sql"))
history_dx <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/history_dx.sql"))

```

# Joining 1º df

```{r}
#Unimos df
dfs_to_join <- list(patients_total,
                    patients_admit,
                    apacheadmission,
                    patients_emergency,
                    apachescore,
                    sensitivitylevel,
                    charlson_score,
                    history_dx) #apache_sepsis,apache_infection

final_df <- Reduce(function(x,y) merge(x,y, by = "patientunitstayid", all.x = TRUE), dfs_to_join)


##Criterio exlcusion
a <- nrow(final_df)
print('Initial number of patients: ')
print(a)
```

# Exclusion criteria

```{r}
# Age
final_df$age <- as.numeric(gsub("> 89", "90", final_df$age))
final_df <- final_df[final_df$age >= 16,]

##Criterio exclusión
print('Patients >=16 ')
b <- nrow(final_df)
print(b)

# Hospitaladmitoffset = er_los
# Cambio de nombre, paso de minutos a horas y valores absolutos
final_df <- final_df %>%
  mutate(er_los_hrs = abs(hospitaladmitoffset/60)) %>%
  select(-hospitaladmitoffset)

# Quitar valores muy altos considerados outcome
final_df <- final_df %>%
  filter(er_los_hrs <= 24)

print('Patients in emergency department during 24 hrs')
c <- nrow(final_df)
print(c)

# Sex
final_df <- final_df %>%
  rename(sex = gender) %>%
  drop_na(sex)

##Criterio exclusión
print('Patients with sex known: ')
d <- nrow(final_df)
print(d)

# Hospital admit source (emergency department)
#Emilinamos NA
final_df <- final_df %>%
  drop_na(hospitaladmitsource)

##Cristerios exclusion
print('patient with emergency department')
e <- nrow(final_df)
print(e)

# Unitstaytype
# Eliminamos NA
final_df <- final_df %>%
  drop_na(unitstaytype)

##Cristerios exclusion
print('patient with unit stay type admit')
f <- nrow(final_df)
print(f)

# Apache admission dx
#Eliminamos filas sin valores, NA
final_df <- final_df %>% 
  drop_na(apacheadmissiondx)

## Cristerios exclusion
print('Patients with apache admission dx known')
g <- nrow(final_df)
print(g)

write.csv(final_df, file = "C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Figures/final_df_sinimputar.csv", row.names = FALSE)
```

# Imputations 

### Sex

```{r}
#Variable género = sex, a numérica: hombre = 0, mujer = 1
final_df <- final_df %>%
  mutate(sex = ifelse(
    sex == "Male", "M",
    ifelse(
      sex == "Female", "F", NA
      #NA_character_   #Agregué un valor por defecto para el caso en que sex no sea ni "Male" ni "Female"
    )
  )) %>%
  mutate(sex = as.factor(sex)) %>%
  #mutate(sex = forcats::fct_na_value_to_level(sex)) %>%
  filter(sex != "Unknown")
```

###Unittype

```{r}
# Variable unittype, agrupar en las 5 categorías con mayor valor y el resto agrupadas en la variable other (esto se hace debido a la poca cantidad que hay de muchas de esas categorias de tipo de UCI)

# Cuenta la frecuencia de cada categoría
unittype_counts <- final_df %>%
  count(unittype, name = "Frequency")
# Identifica las 5 categorías más frecuentes
top_categories <- unittype_counts %>%
  top_n(n = 4, wt = Frequency) %>%
  pull(unittype)
# Agrupa las categorías menos frecuentes bajo "Other"
final_df <- final_df %>%
 mutate(unittype = fct_lump(unittype, n = 4, other_level = "Other"))
# Vuelve a contar la frecuencia después de la agrupación
top_unittype <- final_df %>%
  count(unittype, name = "Frequency")
# Muestra el resultado
print(top_unittype)

#Lista de las 5 categorías con más valores
top_categories <- c( "Cardiac ICU",
  "CCU-CTICU",
  "Med-Surg ICU",
  "MICU",
  "Other")

# Crear una nueva variable "apacheadmissiondx_recoded" que recodifique las categorías no incluidas en el ranking como "Other"
final_df <- final_df %>%
  mutate(
    unittype = recode(
      unittype,
      "CSICU" = "Other",
      "CTICU" = "Other",
      "Neuro ICU" = "Other",
      "SICU" = "Other"))
```

### Apache admission dx

```{r}
# Unimos bajo un mismo nombre: pneumonia, bacterial y sepsis pulmonary = sepsis, pneumonia
final_df <- final_df %>%
  mutate(apacheadmissiondx = ifelse(apacheadmissiondx %in% c("Pneumonia, bacterial", "Sepsis, pulmonary"), "sepsis, pneumonia", apacheadmissiondx))

# Variable apache admission, agrupar en las 5 categorías con mayor valor y el resto agrupadas en la variable other (esto se hace debido a la poca cantidad que hay de muchas de esas categorias de diagnósticos)

# Cuenta la frecuencia de cada categoría
apache_counts <- final_df %>%
  count(apacheadmissiondx, name = "Frequency")
# Identifica las 5 categorías más frecuentes
top_categories <- apache_counts %>%
  top_n(n = 5, wt = Frequency) %>%
  pull(apacheadmissiondx)
# Agrupa las categorías menos frecuentes bajo "Other"
final_df <- final_df %>%
 mutate(apacheadmissiondx = fct_lump(apacheadmissiondx, n = 5, other_level = "Other"))
# Vuelve a contar la frecuencia después de la agrupación
top_apacheadmissiondx <- final_df %>%
  count(apacheadmissiondx, name = "Frequency")
# Muestra el resultado
print(top_apacheadmissiondx)

#Lista de las 10 categorías con más valores
top_categories <- c("sepsis, pneumonia",
  "Sepsis, GI",
  "Sepsis, cutaneous/soft tissue",
  "Sepsis, renal/UTI (including bladder)",
  "Sepsis, unknown",
  "Other")

# Crear una nueva variable "apacheadmissiondx_recoded" que recodifique las categorías no incluidas en el ranking como "Other"
final_df <- final_df %>%
  mutate(
    apacheadmissiondx = recode(
      apacheadmissiondx,
      "Sepsis, cutaneous/soft tissue" = "Other",
      "Pneumonia, other" = "Other",
      "Pneumonia, aspiration" = "Other",
      "Renal infection/abscess" = "Other",
      "Cellulitis and localized soft tissue infections" = "Other",
      "Sepsis, other" = "Other",
      "Sepsis, gynecologic" = "Other",
      "Infection/abscess, other surgery for" = "Other",
      "Abscess/infection-cranial, surgery for" = "Other",
      "Cellulitis and localized soft tissue infections, surgery for" = "Other",
      "GI perforation/rupture, surgery for" = "Other",
      "Abscess, neurologic" = "Other",
      "GI perforation/rupture" = "Other",
      "Complications of previous open-heart surgery, surgery for (i.e. bleeding, infection, mediastinal rewiring,leaking aortic graft etc.)" = "Other",
      "Complications of previous GI surgery; surgery for (anastomotic leak, bleeding, abscess, infection, dehiscence, etc.)" = "Other",
      "Diverticular disease, surgery for" = "Other",
      "GI obstruction, surgery for (including lysis of adhesions)" = "Other",                                                                       
      "ARDS-adult respiratory distress syndrome, non-cardiogenic pulmonary edema" = "Other",                                                         
      "Thoracotomy for thoracic/respiratory infection" = "Other",                                                                                    
      "Endocarditis"  = "Other",                                                                                                                      
      "Pneumonia, viral" = "Other",
      "Cholecystectomy/cholangitis, surgery for (gallbladder removal)"  = "Other",                                                                    
      "Arthritis, septic"  = "Other",                                                                                                               
      "Meningitis"  = "Other",                                                                                                                     
      "Complications of previous open heart surgery (i.e. bleeding, infection etc.)"  = "Other",                                                     
      "Fistula/abscess, surgery for (not inflammatory bowel disease)" = "Other",                                                                      
      "Sepsis, gynecologic" = "Other",                                                                                                                
      "GI Abscess/cyst-primary, surgery for"  = "Other",                                                                                              
      "Pancreatitis, surgery for" = "Other",
      "GI abscess/cyst"  = "Other",                                                                                                                   
      "Peritonitis" = "Other",                                                                                                                      
      "Peritonitis, surgery for"   = "Other",                                                                                                         
      "Pneumonia, fungal" = "Other",                                                                                                                  
      "Pneumonia, parasitic (i.e., Pneumocystic pneumonia)" = "Other",                                                                                
      "Inflammatory bowel disease, surgery for" = "Other",                                                                                            
      "Myositis, viral"  = "Other" 
    )
  )
```

### Ethnicity

```{r}
# Change empty string = other
final_df <- final_df %>%
  mutate(ethnicity = ifelse(ethnicity %in% c("", "other", "Other/Unknown", "African American", "Asian", "Hispanic", "Native American"), "other/unknown", ethnicity))
```

### Stratify: Unitdischargestatus (estado del que sale de la unidad)

```{r}
final_df <- final_df %>%
  mutate(
    unitdischargestatus = ifelse(
      unitdischargestatus == 'Expired', 1,
      ifelse(trimws(unitdischargestatus) == '' | unitdischargestatus == 'Alive', 0, NA)
    )
  )

```

### Apachescore,change name and na = median

```{r}
final_df <- final_df %>%
  mutate(apachescoreIV = ifelse(is.na(apachescoreIV) | apachescoreIV == -1, median(apachescoreIV[apachescoreIV != -1], na.rm = TRUE), apachescoreIV))
```

### Variable sensitivity:level, change na = no infection

```{r}
final_df <- final_df %>%
  mutate(
    bact_resist_level = replace_na(final_df$bact_resist_level, 'Not infection')
  )
```

### History.dx. 

```{r}
final_df<- final_df %>%
  mutate(hist_metastasis_bin = replace_na(hist_metastasis_bin, 0)) %>%
  mutate(hist_vih_sida_bin = replace_na(hist_vih_sida_bin, 0)) %>%
  mutate(hist_cirrosis_liver_bin = replace_na(hist_cirrosis_liver_bin, 0)) %>%
  mutate(hist_stroke_bin = replace_na(hist_stroke_bin, 0)) %>%
  mutate(hist_renal_bin = replace_na(hist_renal_bin, 0)) %>%
  mutate(hist_diabetes_bin = replace_na(hist_diabetes_bin, 0)) %>%
  mutate(hist_cancer_bin = replace_na(hist_cancer_bin, 0)) %>%
  mutate(hist_leukemia_bin = replace_na(hist_leukemia_bin, 0)) %>%
  mutate(hist_lymphoma_bin = replace_na(hist_lymphoma_bin, 0)) %>%
  mutate(hist_myocardial_infar_bin = replace_na(hist_myocardial_infar_bin, 0)) %>%
  mutate(hist_chf_bin = replace_na(hist_chf_bin, 0)) %>%
  mutate(hist_pvd_bin = replace_na(hist_pvd_bin, 0)) %>%
  mutate(hist_tia_bin = replace_na(hist_tia_bin, 0)) %>%
  mutate(hist_dementia_bin = replace_na(hist_dementia_bin, 0)) %>%
  mutate(hist_copd_bin = replace_na(hist_copd_bin, 0)) %>%
  mutate(hist_ctd_bin = replace_na(hist_ctd_bin, 0)) %>%
  mutate(hist_pud_bin = replace_na(hist_pud_bin, 0)) %>%
  mutate(hist_liver_bin = replace_na(hist_liver_bin, 0))
```

```{r}
# Lista de variables
variables <- c("hist_metastasis_bin", "hist_vih_sida_bin", "hist_cirrosis_liver_bin", "hist_stroke_bin", 
               "hist_renal_bin", "hist_diabetes_bin", "hist_cancer_bin", "hist_leukemia_bin", 
               "hist_lymphoma_bin", "hist_myocardial_infar_bin", "hist_chf_bin", "hist_pvd_bin", 
               "hist_tia_bin", "hist_copd_bin", "hist_ctd_bin", 
               "hist_pud_bin", "hist_liver_bin")

# Utilizar dplyr para realizar el conteo y seleccionar las cinco variables con más 1
top5_hist_dx <- final_df %>%
  select(all_of(variables)) %>%
  summarise(across(everything(), ~sum(. == 1), .names = "Conteo_{.col}")) %>%
  pivot_longer(everything(), names_to = "Variable", values_to = "Conteo") %>%
  arrange(desc(Conteo)) %>%
  head(5)

# Mostrar el resultado final
print(top5_hist_dx)

# Agrupar resto de hist en una misma variable other
## Columna de cada pacientes donde se indica el total de cormobilidades que tiene cada uno de ellos
final_df <- final_df %>%
  mutate(hist_other = rowSums(select(., starts_with("hist_")) == 1))

## Columna de cada paciente codificada en 0 y 1, 0 sino tiene nada , 1 si tiene 1 o más cormobilidades
final_df <- final_df %>%
  mutate(hist_other_bin = ifelse(hist_other == 0, 0, 1))

```

# Df order 

```{r}
#Orden de las variables
final_df_order <- final_df %>%
  select(patientunitstayid, sex,age,ethnicity,er_los_hrs,apacheadmissiondx,unittype, apachescoreIV,bact_resist_level, final_charlson_score, hist_diabetes_bin,hist_copd_bin,hist_chf_bin,hist_cancer_bin,hist_renal_bin,hist_other_bin,unitdischargestatus) #sepsis_bin,infection_bin
```

##Variables dummy

### Unittype

```{r}
#Transformar a dummy
unittype_ <- factor(final_df_order$unittype)
dummies_unittype <- dummy_cols(final_df_order$unittype, remove_first_dummy =  FALSE)

# Incluir en df 
final_df_order <- data.frame(final_df_order,dummies_unittype[,2:5])

#Cambiamos nombrs de las variables
final_df_order <- rename(final_df_order, unit_ccu_cticu = .data_CCU.CTICU) %>%
  rename(unit_med_surg_icu = .data_Med.Surg.ICU) %>%
  rename(unit_micu = .data_MICU) %>%
  rename(unit_other = .data_Other)
```

### Apache admission dx
```{r}
#Transformar a dummy
dummies_apacheadmissiondx <- dummy_cols(final_df_order$apacheadmissiondx, remove_first_dummy = FALSE)

## Incluir dummies en el df final
final_df_order <- data.frame(final_df_order,dummies_apacheadmissiondx[,2:7])

## Cambiamos nombres de la variables dummies de apache para mejor entendimiento
final_df_order <- rename(final_df_order,apacheadmissiondx_other = .data_Other) %>%
  rename(apacheadmissiondx_pneumonia_bacterial = .data_Pneumonia..bacterial) %>%
  rename(apacheadmissiondx_sepsis_gi = .data_Sepsis..GI) %>%
  rename(apacheadmissiondx_sepsis_pulmonary = .data_Sepsis..pulmonary) %>%
  rename(apacheadmissiondx_sepsis_renal_uti = .data_Sepsis..renal.UTI..including.bladder.) %>%
  rename(apacheadmissiondx_sepsis_unknown = .data_Sepsis..unknown)
```

# Final df

```{r}
final_df_er_sepsis <- final_df_order %>%
  select(unitdischargestatus,er_los_hrs, sex, age, ethnicity, apachescoreIV,  final_charlson_score, hist_diabetes_bin, hist_renal_bin, hist_cancer_bin, hist_chf_bin, hist_copd_bin,hist_other_bin,unittype,apacheadmissiondx,bact_resist_level)

final_df_er_sepsis <- distinct(final_df_er_sepsis)

final_df_er_sepsis_dummy <- final_df_order %>%
  select(patientunitstayid, sex,age,ethnicity,er_los_hrs,apacheadmissiondx_other,apacheadmissiondx_pneumonia_bacterial,apacheadmissiondx_sepsis_gi,apacheadmissiondx_sepsis_pulmonary,apacheadmissiondx_sepsis_renal_uti,apacheadmissiondx_sepsis_unknown,unit_ccu_cticu,unit_med_surg_icu,unit_micu,unit_other, apachescoreIV, final_charlson_score, hist_diabetes_bin,hist_copd_bin,hist_chf_bin,hist_cancer_bin,hist_renal_bin,hist_other_bin,unitdischargestatus) #sepsis_bin,infection_bin
```

## Variable factor

```{r}
## Variable bact_resist_level
#final_df_er_sepsis$bact_resist_level <- as.factor(final_df_er_sepsis$bact_resist_level)

## Variable ethnicity
final_df_er_sepsis$ethnicity <- as.factor(final_df_er_sepsis$ethnicity)

## Variable sepsis_bin
#final_df_er_sepsis$sepsis_bin <- as.factor(final_df_er_sepsis$sepsis_bin)

## Variable infection_bin
#final_df_er_sepsis$infection_bin <- as.factor(final_df_er_sepsis$infection_bin)

##Variable sex
final_df_er_sepsis$sex <- as.factor(final_df_er_sepsis$sex)

##Variable dummies_apacheadmissiondx
final_df_er_sepsis <- final_df_er_sepsis %>%
  mutate_at(vars(apacheadmissiondx_other, apacheadmissiondx_pneumonia_bacterial, apacheadmissiondx_sepsis_gi, apacheadmissiondx_sepsis_pulmonary, apacheadmissiondx_sepsis_renal_uti, apacheadmissiondx_sepsis_unknown),as.factor)

## Variable apacheadmissiondx
#final_df_er_sepsis$apacheadmissiondx <- as.factor(final_df_er_sepsis$apacheadmissiondx)

##Variable dummies_unittype
final_df_er_sepsis <- final_df_er_sepsis %>%
  mutate_at(vars(unit_ccu_cticu,unit_med_surg_icu,unit_micu, unit_other), as.factor)

## Variable unittype
#final_df_er_sepsis$unittype <- as.factor(final_df_er_sepsis$unittype)

## Variables history
final_df_er_sepsis <- final_df_er_sepsis %>%
  mutate_at(vars(hist_diabetes_bin,hist_copd_bin,hist_chf_bin,hist_cancer_bin,hist_renal_bin,hist_other_bin), as.factor)

##Variable unitdischargestatus
final_df_er_sepsis$unitdischargestatus <- as.factor(final_df_er_sepsis$unitdischargestatus)

```

```{r}
write.csv(final_df_er_sepsis, file = "C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Figures/selected_data.csv", row.names = FALSE)
```

# PCA VARIABLES
```{r}
final_df_numeric <- final_df_er_sepsis %>%
  select(unitdischargestatus,er_los_hrs, age, apachescoreIV,  final_charlson_score, hist_diabetes_bin, hist_renal_bin, hist_cancer_bin, hist_chf_bin, hist_copd_bin,hist_other_bin)

resultados_pca <- lapply(final_df_numeric, function(x) prcomp(~ x, scale. = TRUE))
for (i in 1:length(resultados_pca)) {
  print(paste("PCA para", names(final_df_numeric)[i]))
  print(summary(resultados_pca[[i]]))
}
```



# Flowchart

```{r}
titulo <- "Inclusion and Exclusion Criteria Flowchart"
# Crear el código DOT para el diagrama de flujo
flowchart_code <- sprintf("
digraph flowchart {
labelloc=\"t\";  // Colocar el título arriba del diagrama
  label=\"%s\";   //  Título del diagrama
  // Estilo del título
  graph [fontname = 'Arial', fontsize = 20, fontcolor = 'black', color = 'transparent'];
  node [shape = box, fontname = 'Arial', fontsize = 12, color = 'black'];
  a [label = 'Initial number of patients: %d'];
  b [label = 'Patients >=16 %d'];
  c [label = 'Patients in emergency department during 24 hrs: %d'];
  d [label = 'Patients with sex known: %d'];
  e [label = 'patient with emergency department: %d'];
  f [label = 'patient with unit stay type admit: %d'];
  g [label = 'Patients with apache admission dx known: %d'];
  h [label = 'Total Patients: %d']

  a -> b;
  b -> c;
  c -> d;
  d -> e;
  e -> f;
  f -> g;
  g -> h;
}
", titulo, a,b,c,d,e,f,g,h)

# Crear y visualizar el diagrama
grViz(flowchart_code)
```




