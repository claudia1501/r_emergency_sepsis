---
title: "01_dataset_creation"
author: "Claudia Jiménez"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
 output:
   html_notebook:
    code_folding: hide
    number_sections: yes
    theme: flatly
    toc: yes
    toc_float: yes
---
# Environment

```{r message=FALSE, warning=FALSE}
library(bigrquery)
library(DBI)
library(dplyr)
library(summarytools)
library(tidyverse)
```
# BigQuery related functions

This chunks creates the run_query and getSQL function.

```{r}
# Function that takes in a SQL command and runs it on BigQuery. This avoids the connection data in each iteration
run_query<-function(query){
  query_output<-dbGetQuery(con,query)
  return(query_output)
}

# Function for reading SQL files from a folder
getSQL <- function(filepath) {
  con = file(filepath, "r")
  sql.string <- ""
  while (TRUE) {
    line <- readLines(con, n = 1)
    if (length(line) == 0) {
      break
    }
    line <- gsub("\\t", " ", line)
    if (grepl("--", line) == TRUE) {
      line <- paste(sub("--", "/*", line), "*/")
    }
    sql.string <- paste(sql.string, line)
  }
  close(con)
  return(sql.string)
}
```

## Setting up connection

```{r}
bigrquery::bq_auth() # UNCOMMENT WHEN HAVEN TOCKEN ISSUES!!!
# Establecer la conexión a BigQuery
project_id <- readline(prompt = "Enter your project ID: ")

con <- dbConnect(
  bigrquery::bigquery(),
  project = project_id
)

```
# Data Extraction

Loading queries and extracting the data.
```{r}
patients_dates <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/patients_date.sql"))
apachescore <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/apachescore.sql"))
sensitivitylevel <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/sensitivitylevel.sql"))
apache_sepsis <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/apache_sepsis.sql"))
apache_infection <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/apache_infection.sql"))
charlson_score <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/charlson_score.sql"))
history_dx <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/history_dx.sql"))

```

# Joining 1º df
```{r}
#Unimos df
dfs_to_join <- list(patients_dates, apachescore,sensitivitylevel,apache_sepsis,apache_infection,charlson_score,history_dx)
final_df <- Reduce(function(x,y) merge(x,y, by = "patientunitstayid", all.x = TRUE), dfs_to_join)
```

## Imputations 
```{r}
#Pasamos variable edad a númerica. Reemplazamos >89 = 90. Variable género a numérica: hombre = 0, mujer = 1
final_df <- final_df %>%
  mutate(
    age = ifelse(age == '> 89', 90, as.numeric(as.character(age))))

final_df <- final_df %>%
 rename(sex = gender) 

final_df <- final_df %>%
  mutate(sex = ifelse(
    sex == "Male", "0",
    ifelse(
      sex == "Female", "1",
      NA_character_  # Agregué un valor por defecto para el caso en que sex no sea ni "Male" ni "Female"
    )
  )) %>%
  mutate(sex = as.factor(sex)) %>%
  mutate(sex = fct_explicit_na(sex, na_level = "Unknown")) %>%
  filter(sex != "Unknown")

#Change empty string = other
final_df <- final_df %>%
  mutate(ethnicity = ifelse(ethnicity == "", "other", ethnicity)) %>%
   mutate(ethnicity = ifelse(ethnicity %in% c("other", "Other/Unknown"), "other/unknown", ethnicity))

#Variable sepsis_bin and infection_bin. Change: no = 0; sí = 1
final_df <- final_df %>%
  mutate(sepsis_bin = recode(sepsis_bin, "no" = "0")) %>%
  mutate(sepsis_bin = recode(sepsis_bin, "sí" = "1")) %>%
  mutate(infection_bin = recode(infection_bin, "no" = "0")) %>%
  mutate(infection_bin = recode(infection_bin, "sí" = "1"))

# Variable apache admission, agrupar en las 5 categorías con mayor valor y el resto agrupadas en la variable other (esto se hace debido a la poca cantidad que hay de muchas de esas categorias de diagnósticos)

# Cuenta la frecuencia de cada categoría
apache_counts <- final_df %>%
  count(apacheadmissiondx, name = "Frequency")
# Identifica las 5 categorías más frecuentes
top_categories <- apache_counts %>%
  top_n(n = 5, wt = Frequency) %>%
  pull(apacheadmissiondx)
# Agrupa las categorías menos frecuentes bajo "Other"
final_df <- final_df %>%
  mutate(apacheadmissiondx = fct_lump(apacheadmissiondx, n = 5, other_level = "Other"))
# Vuelve a contar la frecuencia después de la agrupación
new_apache_counts <- final_df %>%
  count(apacheadmissiondx, name = "Frequency")
# Muestra el resultado
print(new_apache_counts)

final_df <- final_df %>%
  mutate(
    apacheadmissiondx = recode(
      apacheadmissiondx,
      "Renal infection/abscess" = "other",
      "Cellulitis and localized soft tissue infections" = "other",
      "Sepsis, other" = "other",
      "Sepsis, gynecologic" = "other",
      "Infection/abscess, other surgery for" = "other",
      "Abscess/infection-cranial, surgery for" = "other",
      "Cellulitis and localized soft tissue infections, surgery for" = "other"
    )
  )


```

### Variable unitdischargestatus (estado del que sale de la unidad)
```{r}
library(dplyr)

final_df <- final_df %>%
  mutate(
    unitdischargestatus = ifelse(
      unitdischargestatus == 'Expired', '1',
      ifelse(trimws(unitdischargestatus) == '' | unitdischargestatus == 'Alive', '0', NA_character_)
    )
  )

```
### Variable hospitaladmitoffset, change name
```{r}
final_df <- final_df %>%
  mutate(er_los_hrs = abs(hospitaladmitoffset/60)) %>%
  select(-hospitaladmitoffset)
```
### Variable apachescore,change name and na = median
```{r}
final_df <- final_df %>%
  mutate(apachescoreIV = ifelse(is.na(apachescoreIV), median(apachescoreIV, na.rm = TRUE), apachescoreIV))
```
### Variable sensitivity:level, change na = no infection
```{r}
final_df <- final_df %>%
  mutate(
    bact_resist_level = replace_na(final_df$bact_resist_level, 'Not infection')
  )
```


```{r}
#Orden de las variables
final_df_order <- final_df %>%
  select(patientunitstayid, sex,age,ethnicity,hospitalid,er_los_hrs,sepsis_bin,infection_bin,apacheadmissiondx,hospitaladmitsource,unittype,unitvisitnumber,unitstaytype,unitdischargelocation, unitdischargestatus,uniquepid,apachescoreIV,bact_resist_level, final_charlson_score, hist_metastasis_bin,hist_vih_sida_bin,hist_cirrosis_liver_bin, hist_stroke_bin,hist_renal_bin,hist_diabetes_bin,hist_cancer_bin,hist_leukemia_bin,hist_lymphoma_bin,hist_myocardial_infar_bin,hist_chf_bin,hist_pvd_bin,hist_tia_bin,hist_dementia_bin,hist_copd_bin,hist_ctd_bin,hist_pud_bin,hist_liver_bin)
```


### NA filling df history.dx
```{r}
final_df_order <- final_df_order %>%
  mutate(hist_metastasis_bin = replace_na(hist_metastasis_bin, 0)) %>%
  mutate(hist_vih_sida_bin = replace_na(hist_vih_sida_bin, 0)) %>%
  mutate(hist_cirrosis_liver_bin = replace_na(hist_cirrosis_liver_bin, 0)) %>%
  mutate(hist_stroke_bin = replace_na(hist_stroke_bin, 0)) %>%
  mutate(hist_renal_bin = replace_na(hist_renal_bin, 0)) %>%
  mutate(hist_diabetes_bin = replace_na(hist_diabetes_bin, 0)) %>%
  mutate(hist_cancer_bin = replace_na(hist_cancer_bin, 0)) %>%
  mutate(hist_leukemia_bin = replace_na(hist_leukemia_bin, 0)) %>%
  mutate(hist_lymphoma_bin = replace_na(hist_lymphoma_bin, 0)) %>%
  mutate(hist_myocardial_infar_bin = replace_na(hist_myocardial_infar_bin, 0)) %>%
  mutate(hist_chf_bin = replace_na(hist_chf_bin, 0)) %>%
  mutate(hist_pvd_bin = replace_na(hist_pvd_bin, 0)) %>%
  mutate(hist_tia_bin = replace_na(hist_tia_bin, 0)) %>%
  mutate(hist_dementia_bin = replace_na(hist_dementia_bin, 0)) %>%
  mutate(hist_copd_bin = replace_na(hist_copd_bin, 0)) %>%
  mutate(hist_ctd_bin = replace_na(hist_ctd_bin, 0)) %>%
  mutate(hist_pud_bin = replace_na(hist_pud_bin, 0)) %>%
  mutate(hist_liver_bin = replace_na(hist_liver_bin, 0))
```

#Save final df
```{r}
final_df_er_sepsis <- final_df_order %>%
  select(patientunitstayid, sex,age,ethnicity,hospitalid,er_los_hrs,sepsis_bin,infection_bin,apacheadmissiondx,unittype, unitdischargestatus,apachescoreIV,bact_resist_level, final_charlson_score, hist_metastasis_bin,hist_vih_sida_bin,hist_cirrosis_liver_bin, hist_stroke_bin,hist_renal_bin,hist_diabetes_bin,hist_cancer_bin,hist_leukemia_bin,hist_lymphoma_bin,hist_myocardial_infar_bin,hist_chf_bin,hist_pvd_bin,hist_tia_bin,hist_dementia_bin,hist_copd_bin,hist_ctd_bin,hist_pud_bin,hist_liver_bin)

write.csv(final_df_er_sepsis, file = "C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Figures/selected_data.csv", row.names = FALSE)
```



