<<<<<<< HEAD
---
title: "01_dataset_creation"
author: "Claudia Jiménez"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
# output:
#   html_notebook:
#     code_folding: hide
#     number_sections: yes
#     theme: flatly
#     toc: yes
#     toc_float: yes
---
# Environment

```{r message=FALSE, warning=FALSE}
library(bigrquery)
library(DBI)
library(dplyr)
```
# BigQuery related functions

This chunks creates the run_query and getSQL function.

```{r}
# Function that takes in a SQL command and runs it on BigQuery. This avoids the connection data in each iteration
run_query<-function(query){
  query_output<-dbGetQuery(con,query)
  return(query_output)
}

# Function for reading SQL files from a folder
getSQL <- function(filepath) {
  con = file(filepath, "r")
  sql.string <- ""
  while (TRUE) {
    line <- readLines(con, n = 1)
    if (length(line) == 0) {
      break
    }
    line <- gsub("\\t", " ", line)
    if (grepl("--", line) == TRUE) {
      line <- paste(sub("--", "/*", line), "*/")
    }
    sql.string <- paste(sql.string, line)
  }
  close(con)
  return(sql.string)
}
```

## Setting up connection

```{r}
bigrquery::bq_auth() # UNCOMMENT WHEN HAVEN TOCKEN ISSUES!!!
# Establecer la conexión a BigQuery
project_id <- readline(prompt = "Enter your project ID: ")

con <- dbConnect(
  bigrquery::bigquery(),
  project = project_id
)

```
# Data Extraction

Loading queries and extracting the data.
```{r}
patients_dates <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/patients_date.sql"))
microlab_dates <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/microbiology_tests.sql"))
apachescore <- run_query(getSQL("C:/Users/cjimenez10J/Documents/projects/r_urgencias_sepsis/r_urgencias_sepsis/Analysis/sql/apachescore.sql"))
```

# Joining df
```{r}
#Unimos df
dfs_to_join <- list(patients_dates,microlab_dates,apachescore)
final_df <- Reduce(function(x,y) merge(x,y, by = "patientunitstayid", all.x = TRUE), dfs_to_join)
```

# Creación de nuevas variables y ajustes
```{r}
#Pasamos variable edad a númerica. Reemplazamos >89 = 90. Variable género a numérica: hombre = 0, mujer = 1
final_df <- final_df %>%
  mutate(
    age_num = ifelse(age == '>89', 90, as.numeric(as.character(age))),
    gender_num = case_when(
      gender == 'Male' ~ 0,
      gender == 'Female' ~ 1,
      trimws(gender) == '' | trimws(gender) == 'Unknown' ~ NA_real_,
      TRUE ~ NA_real_
    )
  )

```
#Variable hospitaldischargestatus (estado del que sale del hospital)
```{r}
#Pasamos variable a numérica. Expire = 0, Alive = 1
final_df <- final_df %>% 
  mutate(
    hospitaldischargestatus = ifelse(hospitaldischargestatus == 'Expired', 0,
                                          ifelse(hospitaldischargestatus == 'Alive', 1,
                                                 ifelse(trimws(hospitaldischargestatus) == '', NA_real_, NA_real_))))
```

#Variable unitdischargestatus (estado del que sale de la unidad)
```{r}
final_df <- final_df %>%
  mutate(unitdischargestatus = ifelse(unitdischargestatus == 'Expired', 0,
                                      ifelse(unitdischargestatus == 'Alive', 1,
                                             ifelse(trimws(unitdischargestatus) == '', NA_real_, NA_real_))))
```
#Variable hospitaladmitoffset, change name
```{r}
final_df <- final_df %>%
  rename(lengthofstay = hospitaladmitoffset)
```


```{r}
#Orden de las variables
final_df_order <- final_df %>%
  select(patientunitstayid, patienthealthsystemstayid, gender_num, age_num,ethnicity,hospitalid, wardid,apacheadmissiondx,admissionheight,lengthofstay,hospitaladmitsource,hospitaldischargeyear,hospitaldischargeoffset,hospitaldischargelocation, hospitaldischargestatus, unittype,unitadmitsource,unitvisitnumber,unitstaytype,admissionweight,dischargeweight,unitdischargeoffset,unitdischargelocation, unitdischargestatus,uniquepid,culturetakenoffset, culturesite, organism,antibiotic, sensitivitylevel, max_apachescore)
```

#Exploración valores na, null, vacíos. Imputaciones o eliminación
```{r}
##Columns with na values
print('Columns in total_dataset having NAs')
names(final_df_order)[colSums(is.na(final_df_order)) > 0]
colSums(is.na(final_df_order))
```
##Variable gender_num = 6
```{r}
#Calcular proporción de género en casos conocidos 
proporcion_genero <- table(final_df_order$gender_num, useNA = "no")/sum(!is.na(final_df_order$gender_num))

#Imputar valores faltantes en función de la proporción
set.seed(123)

#Establezco semilla para que los resultados sean reproduciebles
valores_imputados <- sample(names(proporcion_genero), sum(is.na(final_df_order$gender_num)), replace = TRUE, prob = proporcion_genero)

#Asignamos los valores imputados a final_df_order
final_df_order$gender_num[is.na(final_df_order$gender_num)] <- valores_imputados
```
##Variable age_num
```{r}

```





